user  www-data www-data; 
worker_processes 4;
pid        /usr/local/web/nginx/nginx.pid;
worker_rlimit_nofile 65535;
events 
{
	use epoll;
	worker_connections 65535;
}
http 
{
	include       mime.types;
	default_type  application/octet-stream;
	charset       utf-8;
	server_names_hash_bucket_size 128;
	client_header_buffer_size     32k;
	large_client_header_buffers   4 32k;
        client_body_buffer_size       50m;
	client_max_body_size          50m;
	sendfile          on;
	tcp_nopush        on;
	keepalive_timeout 60;
	tcp_nodelay       on;
	fastcgi_connect_timeout 300;
	fastcgi_send_timeout    300;
	fastcgi_read_timeout    300;
	fastcgi_buffer_size     1024k;
	fastcgi_buffers         32 1024k;
	fastcgi_busy_buffers_size 2048k;
	fastcgi_temp_file_write_size 2048k;
        request_pool_size 1k;
        lua_socket_buffer_size 1k;
	gzip             on;
	gzip_comp_level  6;
	gzip_min_length  1k;
	gzip_buffers     4 16k;
	gzip_http_version 1.0;
        gzip_disable "MSIE [1-6].";
        gzip_types text/plain application/x-javascript text/css application/xml application/json  text/javascript;
	gzip_vary    on;
        lua_package_path "/var/www/web/?.lua;;";
	log_format access
                '$remote_addr:$remote_port $remote_user[$time_local] "$request"'
                ' $status $body_bytes_sent "$http_referer"'
                ' "$http_user_agent" $http_x_forwarded_for';
       server
       {
             listen              80;
             server_name admin.test.com;
             root                /var/www/web;
             index              index.html index.htm  index.php;
             if ($fastcgi_script_name ~ \..*\/.*php ) { 
                return 403;
             }
             location ~ \.php$ {
                 try_files      $uri =404;
                 set $path_info $fastcgi_path_info;
                 fastcgi_pass   unix:/dev/shm/php.sock;
                 include        fcgi.conf;
             }
             access_log  /dev/null;
             error_log     /var/www/web/error.log;
       }

       server
       {
             resolver 119.29.29.29;
             listen 80;
             lua_code_cache  off; #生产环境设置为on
             server_name api.test.cn;
	    add_header Access-Control-Allow-Origin '*';
	    add_header Access-Control-Allow-Headers X-Requested-With;
	    add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
             location ~ ^/([-_a-zA-Z0-9/]+) {
                     default_type text/plain;
                     set $path $1;
                     content_by_lua_file /data/lua/web/$path.lua;
             }
	    root /var/www/web;
             access_log  /dev/null;
             error_log   /var/www/web/api.log;
       }

      server
      {
          listen 80;
          server_name sql.test.com;
          root /var/www/web/phpmyadmin;
          index index.php index.html index.htm;

          location / {
              try_files $uri $uri/ /index.php?$query_string;
          }

          location ~ \.php$ {
              try_files $uri =404;
              fastcgi_pass unix:/dev/shm/php-fpm.sock;
              include fastcgi_params;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PATH_INFO $fastcgi_path_info;
          }

          location ~ /\.ht {
              deny all;
          }
           access_log /var/www/web/access.log;
           error_log /var/www/web/error.log;
       }

       include /usr/local/web/nginx/conf/myapp.conf;

}
